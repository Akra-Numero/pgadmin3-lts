<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>37.6. PL/Perl Triggers</title>
<link rel="stylesheet" href="stylesheet.css" type="text/css">
<link rev="made" href="pgsql-docs@postgresql.org">
<meta name="generator" content="DocBook XSL Stylesheets V1.64.1">
<link rel="home" href="index.html" title="PostgreSQL 8.0.0beta2 Documentation">
<link rel="up" href="plperl.html" title="Chapter 37. PL/Perl - Perl Procedural Language">
<link rel="previous" href="plperl-trusted.html" title="37.5. Trusted and Untrusted PL/Perl">
<link rel="next" href="plperl-missing.html" title="37.7. Limitations and Missing Features">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="sect1" lang="en">
<div class="titlepage">
<div><div><h2 class="title" style="clear: both">
<a name="plperl-triggers"></a>37.6. PL/Perl Triggers</h2></div></div>
<div></div>
</div>
<p>   PL/Perl can now be used to write trigger functions using the
<tt class="varname">$_TD</tt> hash reference.
  </p>
<p>   Some useful parts of the $_TD hash reference are:

</p>
<pre class="programlisting">$_TD-&gt;{new}{foo} # NEW value of column foo
$_TD-&gt;{old}{bar} # OLD value of column bar
$_TD{name}       # Name of the trigger being called
$_TD{event}      # INSERT, UPDATE, DELETE or UNKNOWN
$_TD{when}       # BEFORE, AFTER or UNKNOWN
$_TD{level}      # ROW, STATEMENT or UNKNOWN
$_TD{relid}      # Relation ID of the table on which the trigger occurred.
$_TD{relname}    # Name of the table on which the trigger occurred.
@{$_TD{argv}}    # Array of arguments to the trigger function.  May be empty.
$_TD{argc}       # Number of arguments to the trigger.  Why is this here?</pre>
<p>

  </p>
<p>   Triggers can return one of the following:
</p>
<pre class="programlisting">return;   -- Executes the statement
SKIP;     -- Doesn't execute the statement
MODIFY; -- Says it modified a NEW row</pre>
<p>
  </p>
<p>Here is an example of a trigger function, illustrating some of the
above.
</p>
<pre class="programlisting">CREATE TABLE test (
        i int,
        v varchar
);

CREATE OR REPLACE FUNCTION valid_id() RETURNS trigger AS $$
    if (($_TD-&gt;{new}{i}&gt;=100) || ($_TD-&gt;{new}{i}&lt;=0)) {
        return "SKIP";   # Skip INSERT/UPDATE command
    } elsif ($_TD-&gt;{new}{v} ne "immortal") {
        $_TD-&gt;{new}{v} .= "(modified by trigger)";
        return "MODIFY"; # Modify tuple and proceed INSERT/UPDATE command
    } else {
        return;      # Proceed INSERT/UPDATE command
    }
$$ LANGUAGE plperl;

CREATE TRIGGER "test_valid_id_trig" BEFORE INSERT OR UPDATE ON test
FOR EACH ROW EXECUTE PROCEDURE "valid_id"();</pre>
<p>
  </p>
</div></body>
</html>
