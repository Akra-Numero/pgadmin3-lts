<HTML
><HEAD
><TITLE
>Implementation</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.73
"><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="PostgreSQL 7.3.3 Documentation"
HREF="index.html"><LINK
REL="UP"
TITLE="Write-Ahead Logging (WAL)"
HREF="wal.html"><LINK
REL="PREVIOUS"
TITLE="Write-Ahead Logging (WAL)"
HREF="wal.html"><LINK
REL="NEXT"
TITLE="WAL Configuration"
HREF="wal-configuration.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
NAME="creation"
CONTENT="2003-05-24T21:33:34"></HEAD
><BODY
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PostgreSQL 7.3.3 Documentation</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="wal.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Chapter 12. Write-Ahead Logging (<SPAN
CLASS="ACRONYM"
>WAL</SPAN
>)</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="wal-configuration.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="WAL-IMPLEMENTATION"
>12.2. Implementation</A
></H1
><P
>   <SPAN
CLASS="ACRONYM"
>WAL</SPAN
> is automatically enabled from release 7.1
   onwards. No action is required from the administrator with the
   exception of ensuring that the additional disk-space requirements
   of the <SPAN
CLASS="ACRONYM"
>WAL</SPAN
> logs are met, and that any necessary
   tuning is done (see <A
HREF="wal-configuration.html"
>Section 12.3</A
>).
  </P
><P
>   <SPAN
CLASS="ACRONYM"
>WAL</SPAN
> logs are stored in the directory
   <TT
CLASS="FILENAME"
><TT
CLASS="REPLACEABLE"
><I
>$PGDATA</I
></TT
>/pg_xlog</TT
>, as
   a set of segment files, each 16 MB in size.  Each segment is
   divided into 8 kB pages. The log record headers are described in
   <TT
CLASS="FILENAME"
>access/xlog.h</TT
>; record content is dependent on
   the type of event that is being logged.  Segment files are given
   ever-increasing numbers as names, starting at
   <TT
CLASS="FILENAME"
>0000000000000000</TT
>.  The numbers do not wrap, at
   present, but it should take a very long time to exhaust the
   available stock of numbers.
  </P
><P
>   The <SPAN
CLASS="ACRONYM"
>WAL</SPAN
> buffers and control structure are in
   shared memory, and are handled by the backends; they are protected
   by lightweight locks.  The demand on shared memory is dependent on the
   number of buffers.  The default size of the <SPAN
CLASS="ACRONYM"
>WAL</SPAN
>
   buffers is 8 buffers of 8 kB each, or 64 kB total.
  </P
><P
>   It is of advantage if the log is located on another disk than the
   main database files.  This may be achieved by moving the directory,
   <TT
CLASS="FILENAME"
>pg_xlog</TT
>, to another location (while the
   postmaster is shut down, of course) and creating a symbolic link
   from the original location in <TT
CLASS="REPLACEABLE"
><I
>$PGDATA</I
></TT
> to
   the new location.
  </P
><P
>   The aim of <SPAN
CLASS="ACRONYM"
>WAL</SPAN
>, to ensure that the log is
   written before database records are altered, may be subverted by
   disk drives that falsely report a successful write to the kernel,
   when, in fact, they have only cached the data and not yet stored it
   on the disk.  A power failure in such a situation may still lead to
   irrecoverable data corruption.  Administrators should try to ensure
   that disks holding <SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>'s
   log files do not make such false reports.
  </P
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="WAL-RECOVERY"
>12.2.1. Database Recovery with <SPAN
CLASS="ACRONYM"
>WAL</SPAN
></A
></H2
><P
>    After a checkpoint has been made and the log flushed, the
    checkpoint's position is saved in the file
    <TT
CLASS="FILENAME"
>pg_control</TT
>. Therefore, when recovery is to be
    done, the backend first reads <TT
CLASS="FILENAME"
>pg_control</TT
> and
    then the checkpoint record; then it performs the REDO operation by
    scanning forward from the log position indicated in the checkpoint
    record.
    Because the entire content of data pages is saved in the log on the
    first page modification after a checkpoint, all pages changed since
    the checkpoint will be restored to a consistent state.
   </P
><P
>    Using <TT
CLASS="FILENAME"
>pg_control</TT
> to get the checkpoint
    position speeds up the recovery process, but to handle possible
    corruption of <TT
CLASS="FILENAME"
>pg_control</TT
>, we should actually
    implement the reading of existing log segments in reverse order --
    newest to oldest -- in order to find the last checkpoint.  This has
    not been implemented, yet.
   </P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="wal.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="wal-configuration.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Write-Ahead Logging (<SPAN
CLASS="ACRONYM"
>WAL</SPAN
>)</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="wal.html"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><SPAN
CLASS="ACRONYM"
>WAL</SPAN
> Configuration</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>