<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>27.13. Behavior in Threaded Programs</title>
<link rel="stylesheet" href="stylesheet.css" type="text/css">
<link rev="made" href="pgsql-docs@postgresql.org">
<meta name="generator" content="DocBook XSL Stylesheets V1.64.1">
<link rel="home" href="index.html" title="PostgreSQL 8.0.0beta2 Documentation">
<link rel="up" href="libpq.html" title="Chapter 27. libpq - C Library">
<link rel="previous" href="libpq-ssl.html" title="27.12. SSL Support">
<link rel="next" href="libpq-build.html" title="27.14. Building libpq Programs">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="sect1" lang="en">
<div class="titlepage">
<div><div><h2 class="title" style="clear: both">
<a name="libpq-threading"></a>27.13. Behavior in Threaded Programs</h2></div></div>
<div></div>
</div>
<a name="id2611742"></a><p><span class="application">libpq</span> is reentrant and thread-safe if the
<tt class="filename">configure</tt> command-line option
<tt class="literal">--enable-thread-safety</tt> has been used when the
<span class="productname">PostgreSQL</span> distribution was built.  In
addition, you might need to use additional compiler command-line
options when you compile your application code.  Refer to your
system's documentation for information about how to build
thread-enabled applications, or look in 
<tt class="filename">src/Makefile.global</tt> for <tt class="literal">PTHREAD_CFLAGS</tt>
and <tt class="literal">PTHREAD_LIBS</tt>.</p>
<p>One restriction is that no two threads attempt to manipulate the same
<tt class="structname">PGconn</tt> object at the same time. In particular, you cannot
issue concurrent commands from different threads through the same
connection object. (If you need to run concurrent commands, use
multiple connections.)</p>
<p><tt class="structname">PGresult</tt> objects are read-only after creation, and so can be 
passed around freely between threads.</p>
<p>The deprecated functions <tt class="function">PQoidStatus</tt> and
<tt class="function">fe_setauthsvc</tt> are not thread-safe and should not be
used in multithread programs.  <tt class="function">PQoidStatus</tt> can be
replaced by <tt class="function">PQoidValue</tt>.  There is no good reason to
call <tt class="function">fe_setauthsvc</tt> at all.</p>
<p><span class="application">libpq</span> applications that use the
<tt class="literal">crypt</tt> authentication method rely on the
<tt class="literal">crypt()</tt> operating system function, which is often
not thread-safe.<a name="id2611875"></a> It is better to use the <tt class="literal">md5</tt> method,
which is thread-safe on all platforms.</p>
<p><span class="application">libpq</span> must ignore <tt class="literal">SIGPIPE</tt> signals
generated internally by <tt class="function">send()</tt> calls to backend processes.
When <span class="productname">PostgreSQL</span> is configured without
<tt class="literal">--enable-thread-safety</tt>, <span class="application">libpq</span> sets
<tt class="literal">SIGPIPE</tt> to <tt class="literal">SIG_IGN</tt> before each
<tt class="function">send()</tt> call and restores the original signal handler after
completion. When <tt class="literal">--enable-thread-safety</tt> is used,
<span class="application">libpq</span> installs its own <tt class="literal">SIGPIPE</tt> handler
before the first database connection.  This handler uses thread-local
storage to determine if a <tt class="literal">SIGPIPE</tt> signal has been generated
by a libpq <tt class="function">send()</tt>. If an application wants to install
its own <tt class="literal">SIGPIPE</tt> signal handler, it should call
<tt class="function">PQinSend()</tt> to determine if it should ignore the
<tt class="literal">SIGPIPE</tt> signal. This function is available in both
thread-safe and non-thread-safe versions of <span class="application">libpq</span>.</p>
<p>If you experience problems with threaded applications, run
the program in <tt class="filename">src/tools/thread</tt> to see if your
platform has thread-unsafe functions.  This program is run 
by <tt class="filename">configure</tt>, but for binary distributions
your library might not match the library used to build the binaries.</p>
</div></body>
</html>
